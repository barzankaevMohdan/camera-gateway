# üöÄ Camera Gateway - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –Ω–∞ macOS

–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞–º–∏ IP-–∫–∞–º–µ—Ä –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. Node.js –∏ npm
**–í–µ—Ä—Å–∏—è:** Node.js 18.x –∏–ª–∏ –≤—ã—à–µ

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ Homebrew:**
```bash
brew install node@18
# –∏–ª–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π LTS –≤–µ—Ä—Å–∏–∏
brew install node@20
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```bash
node --version
npm --version
```

---

### 2. FFmpeg
**–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤ —Å –∫–∞–º–µ—Ä**

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ Homebrew:**
```bash
brew install ffmpeg
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```bash
ffmpeg -version
```

---

### 3. PostgreSQL (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Prisma)
Camera Gateway –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –∏ Backend. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω –≤ Docker.

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd camera-gateway
npm install
```

---

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `env.example`:
```bash
cp env.example .env
```

–û—Ç–∫—Ä–æ–π—Ç–µ `.env` –∏ —É–∫–∞–∂–∏—Ç–µ:
```env
PORT=4000
NODE_ENV=development
DATABASE_URL=postgresql://attendance_user:secure_password_change_me@localhost:5432/attendance
FFMPEG_PATH=ffmpeg
ENCRYPTION_KEY=your-32-character-encryption-key
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** `ENCRYPTION_KEY` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Ç–∞–∫–∏–º –∂–µ**, –∫–∞–∫ –≤ backend!

---

### –®–∞–≥ 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Prisma —Å—Ö–µ–º—ã

```bash
npm run prisma:copy-schema
npm run prisma:generate
```

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
npm run dev
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω
```bash
npm run build
npm start
```

–°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: `http://localhost:4000`

---

## üìπ –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–∞–º–∏

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

- `GET /health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
- `GET /streams/:cameraId.mjpg` - MJPEG –ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã
- `GET /cameras/:cameraId/test` - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–∞–º–µ—Ä–µ
- `GET /diagnostics` - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –∫–∞–º–µ—Ä

### –ü—Ä–∏–º–µ—Ä RTSP URL

–î–ª—è –∫–∞–º–µ—Ä Hikvision:
```
rtsp://username:password@192.168.1.10:554/ISAPI/Streaming/Channels/101
```

–î–ª—è –∫–∞–º–µ—Ä Dahua:
```
rtsp://username:password@192.168.1.10:554/cam/realmonitor?channel=1&subtype=0
```

---

## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma —Å—Ö–µ–º—ã –∏–∑ backend
npm run prisma:copy-schema
npm run prisma:generate

# –ó–∞–ø—É—Å–∫ —Å –ª–æ–≥–∞–º–∏
npm run dev

# –°–±–æ—Ä–∫–∞
npm run build

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
npm run type-check
```

---

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "ffmpeg not found"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ FFmpeg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: `ffmpeg -version`
- –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FFmpeg: `brew reinstall ffmpeg`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ PATH:
  ```bash
  echo $PATH
  which ffmpeg
  ```

### –û—à–∏–±–∫–∞: "Failed to open camera"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ RTSP-–ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ VLC)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–µ—Ç–∏: `ping 192.168.1.10`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∫–∞–º–µ—Ä—ã
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∏–º –Ω–∞–ø—Ä—è–º—É—é:
  ```bash
  ffmpeg -i "rtsp://admin:password@192.168.1.10:554/ISAPI/Streaming/Channels/101" -frames:v 1 test.jpg
  ```

### –û—à–∏–±–∫–∞: "Cannot connect to database"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Backend –∑–∞–ø—É—â–µ–Ω –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env`

### –û—à–∏–±–∫–∞: "Port 4000 is already in use"
```bash
# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 4000
lsof -ti:4000

# –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
kill -9 $(lsof -ti:4000)
```

---

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
camera-gateway/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config.ts              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ index.ts               # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ prismaClient.ts        # Prisma –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ routes/                # API —Ä–æ—É—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cameras.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ diagnostics.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ streams.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cameraService.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ streamManager.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils/                 # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ       ‚îî‚îÄ‚îÄ encryption.ts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma          # –ö–æ–ø–∏—è —Å—Ö–µ–º—ã –∏–∑ backend
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ sync-prisma-schema.cjs # –°–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ .env                       # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

---

## üìö –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### Backend
Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ Camera Gateway –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤.

### Recognition Service
Recognition Service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Camera Gateway –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤ —Å –∫–∞–º–µ—Ä.

### Frontend
Admin –∏ Client —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –≤–∏–¥–µ–æ, –ø–æ–ª—É—á–∞—è URL —Å—Ç—Ä–∏–º–æ–≤ –æ—Ç Backend:
```
http://localhost:4000/streams/{camera_id}.mjpg
```

---

## üé• –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∫–∞–º–µ—Ä

- **Hikvision** - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ
- **Dahua** - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ
- **–õ—é–±—ã–µ RTSP –∫–∞–º–µ—Ä—ã** - –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å
- **USB –∫–∞–º–µ—Ä—ã** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞)

---

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –æ—Ç–∫—Ä–æ–π—Ç–µ Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏! üöÄ
